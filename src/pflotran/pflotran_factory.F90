module PFLOTRAN_Factory_module

  use PFLOTRAN_Constants_module

  implicit none

  private

#include "finclude/petscsys.h"

  public :: PFLOTRANInitializePrePetsc, &
            PFLOTRANInitializePostPetsc, &
            PFLOTRANFinalize

contains

! ************************************************************************** !

subroutine PFLOTRANInitializePrePetsc(multisimulation,option)
!
! Sets up PFLOTRAN subsurface simulation framework prior to PETSc 
!   initialization
! Author: Glenn Hammond
! Date: 06/07/13
!
  use Option_module
  use Input_Aux_module
  use Multi_Simulation_module
  
  implicit none
  
  type(multi_simulation_type), pointer :: multisimulation
  type(option_type) :: option
  
  character(len=MAXSTRINGLENGTH) :: string
  PetscBool :: bool_flag
  PetscBool :: option_found
  
  ! NOTE: Cannot add anything that requires PETSc in this routine as PETSc 
  !       has not yet been initialized.
  
  call PFLOTRANInitCommandLineSettings(option)
  ! initialize stochastic realizations here
  string = '-stochastic'
  call InputGetCommandLineTruth(string,bool_flag,option_found,option)
  if (option_found) then
    multisimulation => MultiSimulationCreate()
    call MultiSimulationInitialize(multisimulation,option)
  endif
  
end subroutine PFLOTRANInitializePrePetsc

! ************************************************************************** !

subroutine PFLOTRANInitializePostPetsc(multisimulation,option)
!
! Sets up PFLOTRAN subsurface simulation framework after PETSc initialization
! Author: Glenn Hammond
! Date: 06/17/13
!
  use Option_module
  use Multi_Simulation_module
  use Logging_module
  
  implicit none
  
  type(multi_simulation_type), pointer :: multisimulation
  type(option_type) :: option

  ! must come after logging is created
  call LoggingSetupComplete()
  call MultiSimulationIncrement(multisimulation,option)
  call OptionBeginTiming(option)
  
end subroutine PFLOTRANInitializePostPetsc

! ************************************************************************** !

subroutine PFLOTRANFinalize(option)
!
! Destroys PFLOTRAN subsurface simulation framework
! Author: Glenn Hammond
! Date: 06/07/13
!
  use Option_module
  use Logging_module
  
  implicit none
  
  type(option_type) :: option
  PetscErrorCode :: ierr
  
  ! pushed in FinalizeRun()
  call PetscLogStagePop(ierr);CHKERRQ(ierr)
  call OptionEndTiming(option)
  if (option%myrank == option%io_rank .and. option%print_to_file) then
    close(option%fid_out)
  endif

end subroutine PFLOTRANFinalize

! ************************************************************************** !

subroutine PFLOTRANInitCommandLineSettings(option)
  ! 
  ! Initializes PFLOTRAN output filenames, etc.
  ! 
  ! Author: Glenn Hammond
  ! Date: 06/06/13
  ! 

  use Option_module
  use Input_Aux_module
  use String_module
  
  implicit none
  
  type(option_type) :: option
  
  character(len=MAXSTRINGLENGTH) :: string, string2
  PetscBool :: option_found
  PetscBool :: bool_flag
  PetscBool :: pflotranin_option_found
  PetscBool :: input_prefix_option_found
  PetscInt :: i
  PetscErrorCode :: ierr
  
  ! check for non-default input filename
  option%input_filename = 'pflotran.in'
  string = '-pflotranin'
  call InputGetCommandLineString(string,option%input_filename, &
                                 pflotranin_option_found,option)
  string = '-input_prefix'
  call InputGetCommandLineString(string,option%input_prefix, &
                                 input_prefix_option_found,option)
  
  if (pflotranin_option_found .and. input_prefix_option_found) then
    option%io_buffer = 'Cannot specify both "-pflotranin" and ' // &
      '"-input_prefix" on the command lines.'
    call printErrMsg(option)
  else if (pflotranin_option_found) then
    !TODO(geh): replace this with StringSplit()
    i = index(option%input_filename,'.',PETSC_TRUE)
    if (i > 1) then
      i = i-1
    else
      ! for some reason len_trim doesn't work on MS Visual Studio in 
      ! this location
      i = len(trim(option%input_filename)) 
    endif
    option%input_prefix = option%input_filename(1:i)
  else if (input_prefix_option_found) then
    option%input_filename = trim(option%input_prefix) // '.in'
  endif
  
  string = '-output_prefix'
  call InputGetCommandLineString(string,option%global_prefix,option_found,option)
  if (.not.option_found) option%global_prefix = option%input_prefix  
  
  string = '-screen_output'
  call InputGetCommandLineTruth(string,option%print_to_screen,option_found,option)

  string = '-file_output'
  call InputGetCommandLineTruth(string,option%print_to_file,option_found,option)

  string = '-v'
  call InputGetCommandLineInt(string,i,option_found,option)
  if (option_found) option%verbosity = i
 
  ! this will get overwritten later if stochastic
  string = '-realization_id'
  call InputGetCommandLineInt(string,i,option_found,option)
  if (option_found) option%id = i
  
  ! this will get overwritten later if stochastic
  string = '-simulation_mode'
  call InputGetCommandLineString(string,string2, &
                                 option_found,option)
  if (option_found) then
    call StringToUpper(string2)
    option%simulation_mode = string2
  endif

end subroutine PFLOTRANInitCommandLineSettings

end module PFLOTRAN_Factory_module
