\documentclass[12pt]{article} 
\usepackage{times}
\usepackage{amsmath,amsbsy,amssymb}
\usepackage{deflist}
%\usepackage{fancyheadings}
\usepackage{fancyhdr}
\usepackage{tabularx}
\usepackage{verbatim}
\usepackage{moreverb}
\usepackage{float}
\usepackage{fancybox}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{subfigure}
\usepackage{booktabs}
%\usepackage{toc_entr}

\usepackage[super,comma,sort]{natbib} 
%\usepackage[linux]{vpe}
%\vpesetup{noref}
%define citation punctuation style
\bibpunct[, ]{(}{)}{;}{a}{,}{,}

\usepackage[debug=false, colorlinks=true, pdfstartview=FitV, linkcolor=blue, citecolor=black, urlcolor=blue]{hyperref}

\textwidth 6in
\textheight 8.75in
\topmargin -0.75in
%\topmargin -3.280cm 
\newlength{\boxwidth}
\setlength{\boxwidth}{5.8in}
\oddsidemargin 0.25in
\evensidemargin 0.25in
\headheight 0.25in
\lhead{Lichtner \& Lu: {\sl PIMS Tech. Report}}
\chead{} 
%\chead{\rm - \thepage\ -} 
\rhead{DRAFT \qquad \qquad \ \today} 
%\rfoot{\today--[\thepage]}
\rfoot{}
\cfoot{\rm - \thepage\ -}
%\cfoot{}
%\footrulewidth 0.4pt
\newcommand{\negsp}{\vspace{-4mm}} 
\newcommand\secsp{\vspace{-3 mm}}
\newcommand\secspb{\vspace{-2 mm}}
\newcommand\subsecsp{\vspace{-0.0 mm}}
\newcommand\multiflo{{\bf\sl MULTIFLO}}
\newcommand\metra{{\bf\sl METRA}}
\newcommand\gem{{\bf\sl GEM}}
\renewcommand{\baselinestretch}{1.5} 
%\setlength{\baselineskip}{13pt}
\def\EQ#1\EN{\begin{equation}#1\end{equation}}
\def\BA#1\EA{\begin{align}#1\end{align}}
\def\BS#1\ES{\begin{split}#1\end{split}}
%\newcommand{\EQ}{\begin{equation}} 
%\newcommand{\EN}{\end{equation}} 
\newcommand{\longline}{\noindent\rule[-0.1in]{\textwidth}{0.01in}}
\newcommand{\bc}{\begin{center}} 
\newcommand{\ec}{\end{center}} 
\newcommand{\degc}{$^\circ$C} 
\newcommand{\eq}{\ =\ } 
\newcommand{\eff}{{\rm eff}}
\newcommand{\eqr}{{\rm le}}
\newcommand{\equ}{{\rm eq}} 
\newcommand{\kin}{{\rm kin}} 
\newcommand{\rdx}{{\rm rdx}} 
\newcommand{\ind}{{\rm id}} 
\newcommand{\dep}{{\rm dp}}
\newcommand{\e}{{\rm{e}}} 
\newcommand{\erf}{{\rm{erf}}} 
\newcommand{\erfc}{{\rm{erfc}}} 
\renewcommand{\sc}{{\rm sc}}
\newcommand{\sign}{{\rm{sign}}} 
\newcommand{\p}{{\partial}}
\newcommand{\A}{{\mathcal A}}
\newcommand{\B}{{\mathcal B}}
\newcommand{\C}{{\mathcal C}}
\newcommand{\D}{{\mathcal D}}
\newcommand{\E}{{\mathcal E}}
\newcommand{\F}{{\mathcal F}}
\newcommand{\G}{{\mathcal G}}
\newcommand{\J}{{\mathcal J}}
\newcommand{\jo}{{j_o}}
\newcommand{\M}{{\mathcal M}}
\newcommand{\mO}{{\mathcal O}}
\renewcommand{\P}{{{\mathcal P}}}
\newcommand{\Q}{{\mathcal Q}}
\newcommand{\R}{{{\mathcal R}}}
\renewcommand{\S}{{\mathcal S}}
\newcommand{\T}{{\mathcal T}}
\newcommand{\W}{{\mathcal W}}
\newcommand{\X}{{\mathcal X}}
\newcommand{\Y}{{\mathcal Y}}
\newcommand{\Z}{{\mathcal Z}}
\newcommand{\rev}{{\rm rev}}
\newcommand{\irr}{{\rm irr}}
\renewcommand{\a}{{\alpha}} 
\newcommand{\abar}{{\bar \alpha}} 
\renewcommand{\b}{{\beta}} 
\renewcommand{\c}{{\rm CO_2}}
\newcommand{\w}{{\rm H_2O}}
\newcommand{\air}{{\rm N_2}}
\newcommand{\pe}{{\rm Pe}}
\newcommand{\da}{{\rm Da}}
\renewcommand{\k}{{\dot R}^0}
\renewcommand{\L}{\widehat{\mathcal L}}
\renewcommand{\bar}{\overline}
\newcommand{\dsty}{{\displaystyle}}
\newcommand{\diff}{{\mathcal D}} 
\newcommand{\surf}{\equiv \!\!\!}
\newcommand{\bnabla}{\boldsymbol{\nabla}}
\newcommand{\bA}{\boldsymbol{A}}
\newcommand{\ba}{\boldsymbol{a}}
\newcommand{\bB}{\boldsymbol{B}}
\newcommand{\bC}{\boldsymbol{C}}
\newcommand{\bE}{\boldsymbol{E}}
\newcommand{\bF}{\boldsymbol{F}}
\newcommand{\bi}{\boldsymbol{i}}
\newcommand{\bI}{\boldsymbol{I}}
\newcommand{\bJ}{\boldsymbol{J}}
\newcommand{\bK}{\boldsymbol{K}}
\newcommand{\bM}{\boldsymbol{M}}
\newcommand{\bg}{\boldsymbol{g}}
\newcommand{\bGamma}{\boldsymbol{\Gamma}}
\newcommand{\bOmega}{\boldsymbol{\Omega}}
\newcommand{\bPsi}{\boldsymbol{\Psi}}
\newcommand{\bO}{\boldsymbol{O}}
\newcommand{\bnu}{\boldsymbol{\nu}}
\newcommand{\bdS}{\boldsymbol{dS}}
\newcommand{\bq}{\boldsymbol{q}}
\newcommand{\br}{\boldsymbol{r}}
\newcommand{\bR}{\boldsymbol{R}}
\newcommand{\bS}{\boldsymbol{S}}
\newcommand{\bu}{\boldsymbol{u}}
\newcommand{\bv}{\boldsymbol{v}}
\newcommand{\bz}{\boldsymbol{z}}
\newcommand{\arrows}{~\rightleftharpoons~} 
\newcommand{\arrowstab}{\!\!\!\rightleftharpoons\!\!\!} 
\newcommand{\CA}{C_{\rm A}}
\newcommand{\CB}{C_{\rm B}}
\newcommand{\CC}{C_{\rm C}}
\newcommand{\CAB}{C_{\rm AB}}
\newcommand{\CBC}{C_{\rm BC}}
\newcommand{\RA}{\R_{\rm A}}
\newcommand{\RB}{\R_{\rm B}}
\newcommand{\RC}{\R_{\rm C}}
\newcommand{\RAB}{\R_{\rm AB}}
\newcommand{\RBC}{\R_{\rm BC}}
%\newcommand{\kdsc}{K^{DS}}
%\newcommand{\kdec}{K^{DE}}
%\newcommand{\kdsm}{\overline K^{DS}}
%\newcommand{\kdem}{\overline K^{DE}}
\newcommand{\kdsc}{K^{sc}}
\newcommand{\kdec}{K^{ec}}
\newcommand{\kdsm}{K^{sm}}
\newcommand{\kdem}{K^{em}}
\newcommand{\csm}{S}
\renewcommand{\csc}{S}
\newcommand{\cem}{\E}
\newcommand{\cec}{\E}
\renewcommand{\min}{{\rm min}}
\newcommand{\coll}{{\rm coll}}
\newcommand{\ex}{{\rm ex}}
\newcommand{\srf}{{\rm srf}}
\def\dbar{{\mkern2mu\mathchar'26\mkern-11mu\mathrm{d}}}

\renewcommand{\contentsname}{TABLE OF CONTENTS}
\renewcommand{\listfigurename}{{LIST OF FIGURES}}
\renewcommand{\listtablename}{{LIST OF TABLES}}

\renewcommand{\arraystretch}{1.0}

\setlength{\parindent}{0.3125in}
\setlength{\parskip}{2ex plus 0.2ex minus 0.2ex}

\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}

\pagestyle{fancy}
%\pagestyle{empty}

\thispagestyle{empty}

\renewcommand{\theequation}{\arabic{equation}}
%\renewcommand{\thetable}{{\protect\bf\arabic{table}}}
%\renewcommand{\thefigure}{{\protect\bf\arabic{figure}}}
%\renewcommand{\thepage}{\roman{page}}

\begin{document}
%begin title page

\noindent
{\Large\bf PIMS \& PMIS Technical Report}

\begin{comment}

\noindent
{\large\sffamily LA-UR-??-????}

\medskip

\noindent
\scriptsize
{\em Approved for public release;}\\
{\em distribution is unlimited.}

\normalsize

\bc

\begin{tabular}{r|l}
~ & ~\\
{\em Title:} & {\sl PIMS \& PMIS Technical Report}\\
~ & ~\\
~ & ~\\
~ & ~\\
{\em Author(s):} & Chuan Lu (clu@lanl.gov)\\
~ & Peter C. Lichtner (lichtner@lanl.gov)\\
~ & ~\\
~ & ~\\
{\em Submitted to:} & \\
~ & ~\\
~ & ~\\
~ & ~\\
{\em Date:} & \today \\
~ & ~\\
~ & {\bf \large DRAFT}\\
~ & ~\\
\end{tabular}
\ec

\vfill

\noindent
{\Huge\sffamily Los Alamos}

\vspace{-8pt}

\noindent
{\sffamily NATIONAL LABORATORY}

\vspace{-6pt}

\noindent
\scriptsize
Los Alamos National Laboratory, an affirmative action/equal opportunity employer, is operated by the Los Alamos National Security, LLC, for the National Nuclear Security Administration of the U.S. Department of Energy under contract DE-AC52-06NA25396. By acceptance of this article, the publisher recognizes that the U.S. Government retains a nonexclusive, royalty-free license to publish or reproduce the published form of this contribution, or to allow others to do so, for U.S. Government purposes. Los Alamos National Laboratory requests that the publisher identify this article as work performed under the auspices of the U.S. Department of Energy. Los Alamos National Laboratory strongly supports academic freedom and a researcher's right to publish; as an institution, however, the Laboratory does not endorse the viewpoint of a publication or guarantee its technical correctness.

\end{comment}

\normalsize

\tableofcontents
%\clearpage

%\listoffigures

%\listoftables

\clearpage

%\tracingall


\section{Governing equations: PIMS \& PMIS}

The code PIMS, parallel immiscible multiphase flow simulator, is a simplified version of the PFLOTRAN MPHASE mode in which the dependency on thermodynamic relations have been removed, since for immiscible systems the solubility is identically zero for each component. In this case the number of components is equal to the number of phases, or degrees of freedom associated with each node for an isothermal system. The immiscible property removes the variable switching strategy used in MPHASE, which may be the most numerically difficult part of PFLOTRAN, and may cause problems for multi-level solvers. The code PMIS, parallel miscible single phase flow, applies to a completely miscible multicomponent single phase system.

The governing equations solved by PIMS are given by
\EQ\label{mass}
\frac{\p}{\p t}\big(\varphi\rho_\a^{} s_\a^{}\big) + \bnabla\cdot \big(\rho_\a^{} \bq_\a \big) \eq Q_\a,
\EN
where the subscript $\a$ denotes an immiscible phase,. 

For PMIS
\EQ\label{massmis}
\frac{\p}{\p t}\big(\varphi\rho x_i^{}\big) + \bnabla\cdot \big(\rho \bq x_i \big) \eq Q_i,
\EN
for the $i$th component in a single phase system.

In these equations $\varphi$ denotes porosity, $s_\a$, $\rho_\a$ refer to the $\a$th phase saturation and density, respectively, $\bq_\a$ is the Darcy velocity of the $\a$th phase given by
\EQ
\bq_\a \eq -\frac{kk_\a}{\mu_\a} \big(\bnabla p-\rho_\a g \hat\bz\big), 
\EN
with permeability $k$, relative permeability $k_\a$, fluid viscosity $\mu_\a$, and $Q_\a$ is the source/sink term.  
The selection of primary variables are pressure $p$ and $N_p\!-\!1$ independent phase saturation variables $s_\a, \a=1,...,N_p\!-\!1$ with
\EQ
\sum_{\a=1}^{N_p} s_\a = 1.
\EN
The mass conservation equations are coupled to the energy balance equation given by
\EQ
\frac{\p}{\p t} \Big(\varphi\sum_\a s_\a\rho_\a U_\a + (1-\varphi) \rho_r C_r T\Big) + \bnabla\cdot\Big(\sum_\a\rho_\a\bq_\a H_\a - \kappa\bnabla T\Big) \eq Q_e,
\EN
where $U_\a$, $H_\a$ denote the internal energy and enthalpy of the $\a$th fluid phase, $\kappa$ denotes the thermal conductivity of the bulk porous medium, $\rho_r$, $C_r$ denote the rock density and heat capacity, and $T$ refers to the temperature.
%, if incompressibility of all phases or one of them is assumed. In this case, the reference pressure has to be specified as a boundary condition.
%The primary variables also could be $s_i, i=1,...,n$, if suitable EOS are applied to every phases. Then the second type BC could be assigned to all boundaries.
Thus the number of equations is equal to number of phases plus one, which is equal to the number of unknowns: ($p$, $T$, $s_1$, \ldots, $s_{N_p-1}$).

\subsection*{Initial \& Boundary Conditions}
\addcontentsline{toc}{subsection}{\protect\numberline{}{\bf Initial \& Boundary Conditions}} 

At $t=0$ it is necessary to specify the pressure and temperature: $p(\br,\,0)$ and $T(\br,\,0)$, and the phase saturations $s_\a(\br,\,0)$ at position vector $\br$.

Boundary conditions involve specifying Dirichlet, Neumann or zero gradient conditions for the independent variables at the boundary.

\section{Global Mass Conservation}

Global mass conservation implies the equation
\EQ
\frac{dM_\a}{dt} \eq \int_V Q_\a dV - \int_{\p V} \rho_\a \bq_\a \cdot \bdS
\EN
where the total mass of the $\a$th phase is defined as
\EQ
M_\a \eq \int_V \varphi \rho_\a s_\a dV.
\EN
Integrating over time gives
\BA
\int_0^t \frac{dM_\a}{dt}dt &\eq M_\a(t)-M_\a^0,\\
&\eq \int_0^t dt \int_V Q_idV - \int_0^t dt \int_{\p V} \rho_\a \bq_\a \cdot \bdS
\EA
Over a time step $\Delta t$
\EQ
M_\a(t+\Delta t) \eq M_\a(t) + \Delta t \int_V Q_\a dV - \Delta t \int_{\p V} \rho_\a \bq_\a \cdot \bdS.
\EN

\section{PETSc Solver}
PIMS is based on the PETSc SNES nonlinear solver. 
Note: the pre-conditioner option \break {\tt -pc\_factor\_nonzeros\_along\_diagonal} is needed to reduce the chance of getting zero pivot errors. This is because for an incompressible fluid, if the phase saturation is lower than its residual saturation, the flux term is absent and the mass balance equation for that phase is independent of pressure and its adjacent nodes' saturation. 



\section{Numerical Implementation}

Residual:
\EQ
R_{\a n} \eq \Big[(\varphi s_\a\rho_\a)_n^{k+1} - (\varphi s_\a\rho_\a)_n^k\Big] V_n + \Delta t \sum_{n'} \rho_{\a nn'} q_{\a nn'} A_{nn'} - \Delta t \, Q_\a V_n.
\EN

\noindent
Newton-Raphson equations:
\EQ
\left[
\begin{array}{ccc}
J_{\rm H_2O,\,\rm H_2O} & J_{\rm H_2O,\,\rm CO_2} & J_{\rm H_2O,\,\rm E}\\
J_{\rm CO_2,\,\rm H_2O} & J_{\rm CO_2,\,\rm CO_2} & J_{\rm CO_2,\,\rm E}\\
J_{\rm E,\,\rm H_2O} & J_{\rm E,\,\rm CO_2} & J_{\rm E,\,E}
\end{array}
\right]
\left[
\begin{array}{c}
\delta X_{\rm H_2O}\\
\delta X_{\rm CO_2}\\
\delta X_{\rm E}
\end{array}
\right]
\eq
-\left[
\begin{array}{c}
R_{\rm H_2O}\\
R_{\rm CO_2}\\
R_{\rm E}
\end{array}
\right]
\EN

\end{document}
